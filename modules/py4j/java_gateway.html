

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>py4j.java_gateway &mdash; PySpark API 1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="PySpark API 1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PySpark API
          

          
          </a>

          
            
            
              <div class="version">
                1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/pyspark.html">1. pyspark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspark.sql.html">2. pyspark.sql</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspark.ml.html">3. pyspark.ml</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspark.mllib.html">4. pyspark.mllib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspark.streaming.html">5. pyspark.streaming</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PySpark API</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>py4j.java_gateway</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for py4j.java_gateway</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Module to interact with objects in a Java Virtual Machine from a</span>
<span class="sd">Python Virtual Machine.</span>

<span class="sd">Variables that might clash with the JVM start with an underscore</span>
<span class="sd">(Java Naming Convention do not recommend to start with an underscore</span>
<span class="sd">so clashes become unlikely).</span>

<span class="sd">Created on Dec 3, 2009</span>

<span class="sd">:author: Barthelemy Dagenais</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pydoc</span> <span class="k">import</span> <span class="n">pager</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="k">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">RLock</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">py4j.compat</span> <span class="k">import</span> <span class="p">(</span>
    <span class="nb">range</span><span class="p">,</span> <span class="n">hasattr2</span><span class="p">,</span> <span class="n">basestring</span><span class="p">,</span> <span class="n">CompatThread</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">WeakSet</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">py4j.finalizer</span> <span class="k">import</span> <span class="n">ThreadSafeFinalizer</span>
<span class="kn">from</span> <span class="nn">py4j</span> <span class="k">import</span> <span class="n">protocol</span> <span class="k">as</span> <span class="n">proto</span>
<span class="kn">from</span> <span class="nn">py4j.protocol</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Py4JError</span><span class="p">,</span> <span class="n">Py4JNetworkError</span><span class="p">,</span> <span class="n">escape_new_line</span><span class="p">,</span> <span class="n">get_command_part</span><span class="p">,</span>
    <span class="n">get_return_value</span><span class="p">,</span> <span class="n">is_error</span><span class="p">,</span> <span class="n">register_output_converter</span><span class="p">,</span> <span class="n">smart_decode</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">py4j.signals</span> <span class="k">import</span> <span class="n">Signal</span>
<span class="kn">from</span> <span class="nn">py4j.version</span> <span class="k">import</span> <span class="n">__version__</span>


<span class="k">class</span> <span class="nc">NullHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="n">null_handler</span> <span class="o">=</span> <span class="n">NullHandler</span><span class="p">()</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;py4j&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">null_handler</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;py4j.java_gateway&quot;</span><span class="p">)</span>

<span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="n">DEFAULT_ADDRESS</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">25333</span>
<span class="n">DEFAULT_PYTHON_PROXY_PORT</span> <span class="o">=</span> <span class="mi">25334</span>
<span class="n">DEFAULT_ACCEPT_TIMEOUT_PLACEHOLDER</span> <span class="o">=</span> <span class="s2">&quot;DEFAULT&quot;</span>
<span class="n">DEFAULT_CALLBACK_SERVER_ACCEPT_TIMEOUT</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">PY4J_SKIP_COLLECTIONS</span> <span class="o">=</span> <span class="s2">&quot;PY4J_SKIP_COLLECTIONS&quot;</span>
<span class="n">PY4J_TRUE</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">])</span>


<span class="n">server_connection_stopped</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Signal sent when a Python (Callback) Server connection is stopped.</span>

<span class="sd">Will supply the ``connection`` argument, an instance of CallbackConnection.</span>

<span class="sd">The sender is the CallbackServer instance.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">server_connection_started</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Signal sent when a Python (Callback) Server connection is started.</span>

<span class="sd">Will supply the ``connection`` argument, an instance of CallbackConnection.</span>

<span class="sd">The sender is the CallbackServer instance.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">server_connection_error</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Signal sent when a Python (Callback) Server encounters an error while</span>
<span class="sd">waiting for a connection.</span>

<span class="sd">Will supply the ``error`` argument, an instance of Exception.</span>

<span class="sd">The sender is the CallbackServer instance.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">server_started</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Signal sent when a Python (Callback) Server is started</span>

<span class="sd">Will supply the ``server`` argument, an instance of CallbackServer</span>

<span class="sd">The sender is the CallbackServer instance.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">server_stopped</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Signal sent when a Python (Callback) Server is stopped</span>

<span class="sd">Will supply the ``server`` argument, an instance of CallbackServer</span>

<span class="sd">The sender is the CallbackServer instance.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">pre_server_shutdown</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Signal sent when a Python (Callback) Server is about to shut down.</span>

<span class="sd">Will supply the ``server`` argument, an instance of CallbackServer</span>

<span class="sd">The sender is the CallbackServer instance.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">post_server_shutdown</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Signal sent when a Python (Callback) Server is shutted down.</span>

<span class="sd">Will supply the ``server`` argument, an instance of CallbackServer</span>

<span class="sd">The sender is the CallbackServer instance.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">get_create_new_process_group_kwargs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Ensures that the child process is created in another process group.</span>

<span class="sd">    This prevents signals such as SIGINT from propagating to the JVM.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;preexec_fn&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">setpgrp</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;creationflags&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">set_reuse_address</span><span class="p">(</span><span class="n">server_socket</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets reuse address option if not on windows.</span>

<span class="sd">    On windows, the SO_REUSEADDR option means that multiple server sockets can</span>
<span class="sd">    be bound to the same address (it has nothing to do with TIME_WAIT).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
        <span class="n">server_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_default_callback_accept_timeout</span><span class="p">(</span><span class="n">accept_timeout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets default accept timeout of callback server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;set_default_callback_accept_timeout&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
               <span class="s2">&quot;CallbackServerParameters&quot;</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">DEFAULT_CALLBACK_SERVER_ACCEPT_TIMEOUT</span>
    <span class="n">DEFAULT_CALLBACK_SERVER_ACCEPT_TIMEOUT</span> <span class="o">=</span> <span class="n">accept_timeout</span>


<span class="k">def</span> <span class="nf">deprecated</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">last_version</span><span class="p">,</span> <span class="n">use_instead</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
               <span class="n">raise_exc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_instead</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is deprecated and will be removed in version </span><span class="si">{1}</span><span class="s2">&quot;</span>\
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">last_version</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is deprecated and will be removed in version </span><span class="si">{1}</span><span class="s2">. &quot;</span>\
            <span class="s2">&quot;Use </span><span class="si">{2}</span><span class="s2"> instead.&quot;</span>\
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">last_version</span><span class="p">,</span> <span class="n">use_instead</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raise_exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">java_import</span><span class="p">(</span><span class="n">jvm_view</span><span class="p">,</span> <span class="n">import_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Imports the package or class specified by `import_str` in the</span>
<span class="sd">    jvm view namespace.</span>

<span class="sd">    :param jvm_view: The jvm_view in which to import a class/package.</span>
<span class="sd">    :import_str: The class (e.g., java.util.List) or the package</span>
<span class="sd">                 (e.g., java.io.*) to import</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gateway_client</span> <span class="o">=</span> <span class="n">jvm_view</span><span class="o">.</span><span class="n">_gateway_client</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">JVMVIEW_COMMAND_NAME</span> <span class="o">+</span> <span class="n">proto</span><span class="o">.</span><span class="n">JVM_IMPORT_SUB_COMMAND_NAME</span> <span class="o">+</span>\
        <span class="n">jvm_view</span><span class="o">.</span><span class="n">_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">escape_new_line</span><span class="p">(</span><span class="n">import_str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
        <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">return_value</span>


<span class="k">def</span> <span class="nf">find_jar_path</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Tries to find the path where the py4j jar is located.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">jar_file</span> <span class="o">=</span> <span class="s2">&quot;py4j</span><span class="si">{0}</span><span class="s2">.jar&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span>
    <span class="n">maven_jar_file</span> <span class="o">=</span> <span class="s2">&quot;py4j-</span><span class="si">{0}</span><span class="s2">.jar&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jar_file</span><span class="p">)</span>
    <span class="c1"># ant</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="s2">&quot;../../../py4j-java/&quot;</span> <span class="o">+</span> <span class="n">jar_file</span><span class="p">))</span>
    <span class="c1"># maven</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span>
        <span class="s2">&quot;../../../py4j-java/target&quot;</span> <span class="o">+</span> <span class="n">maven_jar_file</span><span class="p">))</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="s2">&quot;../share/py4j/&quot;</span> <span class="o">+</span> <span class="n">jar_file</span><span class="p">))</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../../../current-release/&quot;</span> <span class="o">+</span> <span class="n">jar_file</span><span class="p">)</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;share/py4j/&quot;</span> <span class="o">+</span> <span class="n">jar_file</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">path</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">launch_gateway</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">jarpath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">classpath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">javaopts</span><span class="o">=</span><span class="p">[],</span>
                   <span class="n">die_on_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">redirect_stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">redirect_stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">daemonize_redirect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">java_path</span><span class="o">=</span><span class="s2">&quot;java&quot;</span><span class="p">,</span> <span class="n">create_new_process_group</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Launch a `Gateway` in a new Java process.</span>

<span class="sd">    The redirect parameters accept file-like objects, Queue, or deque. When</span>
<span class="sd">    text lines are sent to the stdout or stderr of the child JVM, these lines</span>
<span class="sd">    are redirected to the file-like object (``write(line)``), the Queue</span>
<span class="sd">    (``put(line)``), or the deque (``appendleft(line)``).</span>

<span class="sd">    The text line will contain a newline character.</span>

<span class="sd">    Only text output is accepted on stdout and stderr. If you wish to</span>
<span class="sd">    communicate with the child JVM through bytes, you need to create your own</span>
<span class="sd">    helper function.</span>

<span class="sd">    :param port: the port to launch the Java Gateway on.  If no port is</span>
<span class="sd">        specified then an ephemeral port is used.</span>
<span class="sd">    :param jarpath: the path to the Py4J jar.  Only necessary if the jar</span>
<span class="sd">        was installed at a non-standard location or if Python is using</span>
<span class="sd">        a different `sys.prefix` than the one that Py4J was installed</span>
<span class="sd">        under.</span>
<span class="sd">    :param classpath: the classpath used to launch the Java Gateway.</span>
<span class="sd">    :param javaopts: an array of extra options to pass to Java (the classpath</span>
<span class="sd">        should be specified using the `classpath` parameter, not `javaopts`.)</span>
<span class="sd">    :param die_on_exit: if `True`, the Java gateway process will die when</span>
<span class="sd">        this Python process exits or is killed.</span>
<span class="sd">    :param redirect_stdout: where to redirect the JVM stdout. If None (default)</span>
<span class="sd">        stdout is redirected to os.devnull. Otherwise accepts a</span>
<span class="sd">        file descriptor, a queue, or a deque. Will send one line at a time</span>
<span class="sd">        to these objects.</span>
<span class="sd">    :param redirect_stderr: where to redirect the JVM stdout. If None (default)</span>
<span class="sd">        stderr is redirected to os.devnull. Otherwise accepts a</span>
<span class="sd">        file descriptor, a queue, or a deque. Will send one line at a time to</span>
<span class="sd">        these objects.</span>
<span class="sd">    :param daemonize_redirect: if True, the consumer threads will be daemonized</span>
<span class="sd">        and will not prevent the main Python process from exiting. This means</span>
<span class="sd">        the file descriptors (stderr, stdout, redirect_stderr, redirect_stdout)</span>
<span class="sd">        might not be properly closed. This is not usually a problem, but in</span>
<span class="sd">        case of errors related to file descriptors, set this flag to False.</span>
<span class="sd">    :param java_path: If None, Py4J will use $JAVA_HOME/bin/java if $JAVA_HOME</span>
<span class="sd">        is defined, otherwise it will use &quot;java&quot;.</span>
<span class="sd">    :param create_new_process_group: If True, the JVM is started in a new</span>
<span class="sd">        process group. This ensures that signals sent to the parent Python</span>
<span class="sd">        process are not forwarded to the JVM. For example, sending</span>
<span class="sd">        Ctrl-C/SIGINT won&#39;t interrupt the JVM. If the python process dies, the</span>
<span class="sd">        Java process will stay alive, which may be a problem for some scenarios</span>
<span class="sd">        though.</span>

<span class="sd">    :rtype: the port number of the `Gateway` server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">popen_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">jarpath</span><span class="p">:</span>
        <span class="n">jarpath</span> <span class="o">=</span> <span class="n">find_jar_path</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">java_path</span><span class="p">:</span>
        <span class="n">java_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;JAVA_HOME&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">java_home</span><span class="p">:</span>
            <span class="n">java_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">java_home</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;java&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">java_path</span> <span class="o">=</span> <span class="s2">&quot;java&quot;</span>

    <span class="c1"># Fail if the jar does not exist.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jarpath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span><span class="s2">&quot;Could not find py4j jar at </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jarpath</span><span class="p">))</span>

    <span class="c1"># Launch the server in a subprocess.</span>
    <span class="n">classpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">jarpath</span><span class="p">,</span> <span class="n">classpath</span><span class="p">))</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">java_path</span><span class="p">,</span> <span class="s2">&quot;-classpath&quot;</span><span class="p">,</span> <span class="n">classpath</span><span class="p">]</span> <span class="o">+</span> <span class="n">javaopts</span> <span class="o">+</span> \
              <span class="p">[</span><span class="s2">&quot;py4j.GatewayServer&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">die_on_exit</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--die-on-broken-pipe&quot;</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Launching gateway with command </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>

    <span class="c1"># stderr redirection</span>
    <span class="k">if</span> <span class="n">redirect_stderr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redirect_stderr</span><span class="p">,</span> <span class="n">Queue</span><span class="p">)</span> <span class="ow">or</span>\
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">redirect_stderr</span><span class="p">,</span> <span class="n">deque</span><span class="p">):</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">PIPE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">redirect_stderr</span>
        <span class="c1"># we don&#39;t need this anymore</span>
        <span class="n">redirect_stderr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># stdout redirection</span>
    <span class="k">if</span> <span class="n">redirect_stdout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">redirect_stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">create_new_process_group</span><span class="p">:</span>
        <span class="n">popen_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_create_new_process_group_kwargs</span><span class="p">())</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">popen_kwargs</span><span class="p">)</span>

    <span class="c1"># Determine which port the server started on (needed to support</span>
    <span class="c1"># ephemeral ports)</span>
    <span class="n">_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

    <span class="c1"># Start consumer threads so process does not deadlock/hangs</span>
    <span class="n">OutputConsumer</span><span class="p">(</span>
        <span class="n">redirect_stdout</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="n">daemonize_redirect</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">redirect_stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">OutputConsumer</span><span class="p">(</span>
            <span class="n">redirect_stderr</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="n">daemonize_redirect</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">ProcessConsumer</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="p">[</span><span class="n">redirect_stdout</span><span class="p">],</span> <span class="n">daemon</span><span class="o">=</span><span class="n">daemonize_redirect</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">_port</span>


<span class="k">def</span> <span class="nf">get_field</span><span class="p">(</span><span class="n">java_object</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the field named `field_name` from the `java_object`.</span>

<span class="sd">    This function is useful when `auto_field=false` in a gateway or</span>
<span class="sd">    Java object.</span>

<span class="sd">    :param java_object: the instance containing the field</span>
<span class="sd">    :param field_name: the name of the field to retrieve</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">FIELD_COMMAND_NAME</span> <span class="o">+</span> <span class="n">proto</span><span class="o">.</span><span class="n">FIELD_GET_SUBCOMMAND_NAME</span> <span class="o">+</span>\
        <span class="n">java_object</span><span class="o">.</span><span class="n">_target_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">field_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
        <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">java_object</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">NO_MEMBER_COMMAND</span> <span class="ow">or</span> <span class="n">is_error</span><span class="p">(</span><span class="n">answer</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span><span class="s2">&quot;no field </span><span class="si">{0}</span><span class="s2"> in object </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">field_name</span><span class="p">,</span> <span class="n">java_object</span><span class="o">.</span><span class="n">_target_id</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_return_value</span><span class="p">(</span>
            <span class="n">answer</span><span class="p">,</span> <span class="n">java_object</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="n">java_object</span><span class="o">.</span><span class="n">_target_id</span><span class="p">,</span>
            <span class="n">field_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_field</span><span class="p">(</span><span class="n">java_object</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the field named `field_name` of `java_object` to `value`.</span>

<span class="sd">    This function is the only way to set a field because the assignment</span>
<span class="sd">    operator in Python cannot be overloaded.</span>

<span class="sd">    :param java_object: the instance containing the field</span>
<span class="sd">    :param field_name: the name of the field to set</span>
<span class="sd">    :param value: the value to assign to the field</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">command_part</span> <span class="o">=</span> <span class="n">get_command_part</span><span class="p">(</span>
        <span class="n">value</span><span class="p">,</span>
        <span class="n">java_object</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">gateway_property</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>

    <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">FIELD_COMMAND_NAME</span> <span class="o">+</span> <span class="n">proto</span><span class="o">.</span><span class="n">FIELD_SET_SUBCOMMAND_NAME</span> <span class="o">+</span>\
        <span class="n">java_object</span><span class="o">.</span><span class="n">_target_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">field_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
        <span class="n">command_part</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="n">java_object</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">NO_MEMBER_COMMAND</span> <span class="ow">or</span> <span class="n">is_error</span><span class="p">(</span><span class="n">answer</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span><span class="s2">&quot;no field </span><span class="si">{0}</span><span class="s2"> in object </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">field_name</span><span class="p">,</span> <span class="n">java_object</span><span class="o">.</span><span class="n">_target_id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">get_return_value</span><span class="p">(</span>
        <span class="n">answer</span><span class="p">,</span> <span class="n">java_object</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="n">java_object</span><span class="o">.</span><span class="n">_target_id</span><span class="p">,</span>
        <span class="n">field_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_method</span><span class="p">(</span><span class="n">java_object</span><span class="p">,</span> <span class="n">method_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves a reference to the method of an object.</span>

<span class="sd">    This function is useful when `auto_field=true` and an instance field has</span>
<span class="sd">    the same name as a method. The full signature of the method is not</span>
<span class="sd">    required: it is determined when the method is called.</span>

<span class="sd">    :param java_object: the instance containing the method</span>
<span class="sd">    :param method_name: the name of the method to retrieve</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">JavaMember</span><span class="p">(</span>
        <span class="n">method_name</span><span class="p">,</span> <span class="n">java_object</span><span class="p">,</span> <span class="n">java_object</span><span class="o">.</span><span class="n">_target_id</span><span class="p">,</span>
        <span class="n">java_object</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_instance_of</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">java_object</span><span class="p">,</span> <span class="n">java_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Indicates whether a java object is an instance of the provided</span>
<span class="sd">    java_class.</span>

<span class="sd">    :param gateway: the JavaGateway instance</span>
<span class="sd">    :param java_object: the JavaObject instance</span>
<span class="sd">    :param java_class: can be a string (fully qualified name), a JavaClass</span>
<span class="sd">            instance, or a JavaObject instance)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">java_class</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">java_class</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">java_class</span><span class="p">,</span> <span class="n">JavaClass</span><span class="p">):</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">java_class</span><span class="o">.</span><span class="n">_fqn</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">java_class</span><span class="p">,</span> <span class="n">JavaObject</span><span class="p">):</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">java_class</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span>
            <span class="s2">&quot;java_class must be a string, a JavaClass, or a JavaObject&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gateway</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">py4j</span><span class="o">.</span><span class="n">reflection</span><span class="o">.</span><span class="n">TypeUtil</span><span class="o">.</span><span class="n">isInstanceOf</span><span class="p">(</span>
        <span class="n">param</span><span class="p">,</span> <span class="n">java_object</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_java_class</span><span class="p">(</span><span class="n">java_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the java.lang.Class of a JavaClass. This is equivalent to</span>
<span class="sd">    calling .class in Java.</span>

<span class="sd">    :param java_class: An instance of JavaClass</span>
<span class="sd">    :rtype: An instance of JavaObject that corresponds to a java.lang.Class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">java_class</span><span class="o">.</span><span class="n">_java_lang_class</span>


<span class="k">def</span> <span class="nf">quiet_close</span><span class="p">(</span><span class="n">closable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quietly closes a closable object without throwing an exception.</span>

<span class="sd">    :param closable: Object with a ``close`` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">closable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Do not attempt to close a None. This logs unecessary exceptions.</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">closable</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception while closing&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">quiet_shutdown</span><span class="p">(</span><span class="n">socket_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quietly shuts down a socket without throwing an exception.</span>

<span class="sd">    :param socket_instance: Socket with ``shutdown`` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">socket_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Do not attempt to close a None. This logs unecessary exceptions.</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">socket_instance</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception while shutting down a socket&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_linger</span><span class="p">(</span><span class="n">a_socket</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets SO_LINGER to true, 0 to send a RST packet. This forcibly closes the</span>
<span class="sd">    connection and the remote socket should fail on write and should not need</span>
<span class="sd">    to read to realize that the socket was closed.</span>

<span class="sd">    Only use on timeout and maybe shutdown because it does not terminate the</span>
<span class="sd">    TCP connection normally.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l_onoff</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">l_linger</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">a_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_LINGER</span><span class="p">,</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;ii&#39;</span><span class="p">,</span> <span class="n">l_onoff</span><span class="p">,</span> <span class="n">l_linger</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">check_connection</span><span class="p">(</span><span class="n">a_socket</span><span class="p">,</span> <span class="n">read_timeout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks that a socket is ready to receive by reading from it.</span>

<span class="sd">    If the read times out, this is a good sign. If the read returns an</span>
<span class="sd">    empty string, this usually means that the socket was remotely closed.</span>

<span class="sd">    :param a_socket: The socket to read from.</span>
<span class="sd">    :param read_timeout: The read_timeout to restore the socket to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a_socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">a_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
        <span class="c1"># Do nothing this is expected!</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">a_socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">read_timeout</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The connection was remotely closed.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gateway_help</span><span class="p">(</span><span class="n">gateway_client</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Displays a help page about a class or an object.</span>

<span class="sd">    :param gateway_client: The gatway client</span>

<span class="sd">    :param var: JavaObject, JavaClass or JavaMember for which a help page</span>
<span class="sd">     will be generated.</span>

<span class="sd">    :param pattern: Star-pattern used to filter the members. For example</span>
<span class="sd">     &quot;get*Foo&quot; may return getMyFoo, getFoo, getFooBar, but not bargetFoo.</span>
<span class="sd">     The pattern is matched against the entire signature. To match only</span>
<span class="sd">     the name of a method, use &quot;methodName(*&quot;.</span>

<span class="sd">    :param short_name: If True, only the simple name of the parameter</span>
<span class="sd">     types and return types will be displayed. If False, the fully</span>
<span class="sd">     qualified name of the types will be displayed.</span>

<span class="sd">    :param display: If True, the help page is displayed in an interactive</span>
<span class="sd">     page similar to the `help` command in Python. If False, the page is</span>
<span class="sd">     returned as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hasattr2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s2">&quot;_get_object_id&quot;</span><span class="p">):</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">HELP_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">HELP_OBJECT_SUBCOMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">var</span><span class="o">.</span><span class="n">_get_object_id</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="n">get_command_part</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">get_command_part</span><span class="p">(</span><span class="n">short_name</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">hasattr2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s2">&quot;_fqn&quot;</span><span class="p">):</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">HELP_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">HELP_CLASS_SUBCOMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">var</span><span class="o">.</span><span class="n">_fqn</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="n">get_command_part</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">get_command_part</span><span class="p">(</span><span class="n">short_name</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">hasattr2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s2">&quot;container&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hasattr2</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span><span class="s2">&quot;pattern should be None with var is a JavaMember&quot;</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(*&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">container</span>
        <span class="k">return</span> <span class="n">gateway_help</span><span class="p">(</span>
            <span class="n">gateway_client</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">display</span><span class="o">=</span><span class="n">display</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span>
            <span class="s2">&quot;var is none of Java Object, Java Class or Java Member&quot;</span><span class="p">)</span>

    <span class="n">help_page</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="p">):</span>
        <span class="n">pager</span><span class="p">(</span><span class="n">help_page</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">help_page</span>


<span class="k">def</span> <span class="nf">_garbage_collect_object</span><span class="p">(</span><span class="n">gateway_client</span><span class="p">,</span> <span class="n">target_id</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ThreadSafeFinalizer</span><span class="o">.</span><span class="n">remove_finalizer</span><span class="p">(</span>
            <span class="n">smart_decode</span><span class="p">(</span><span class="n">gateway_client</span><span class="o">.</span><span class="n">address</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">smart_decode</span><span class="p">(</span><span class="n">gateway_client</span><span class="o">.</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">target_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_id</span> <span class="o">!=</span> <span class="n">proto</span><span class="o">.</span><span class="n">ENTRY_POINT_OBJECT_ID</span> <span class="ow">and</span>\
                <span class="n">target_id</span> <span class="o">!=</span> <span class="n">proto</span><span class="o">.</span><span class="n">GATEWAY_SERVER_OBJECT_ID</span> <span class="ow">and</span>\
                <span class="n">gateway_client</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
                    <span class="n">proto</span><span class="o">.</span><span class="n">MEMORY_COMMAND_NAME</span> <span class="o">+</span>
                    <span class="n">proto</span><span class="o">.</span><span class="n">MEMORY_DEL_SUBCOMMAND_NAME</span> <span class="o">+</span>
                    <span class="n">target_id</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">e</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception while garbage collecting an object&quot;</span><span class="p">,</span>
                             <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception while garbage collecting an object&quot;</span><span class="p">,</span>
                     <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_garbage_collect_connection</span><span class="p">(</span><span class="n">socket_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closes the socket if auto_delete is True and the socket is opened.</span>

<span class="sd">    This is an acceptable practice if you know that your Python VM implements</span>
<span class="sd">    garbage collection and closing sockets immediately is not a concern.</span>
<span class="sd">    Otherwise, it is always better (because it is predictable) to explicitly</span>
<span class="sd">    close the socket by calling `GatewayConnection.close()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">socket_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">quiet_shutdown</span><span class="p">(</span><span class="n">socket_instance</span><span class="p">)</span>
        <span class="n">quiet_close</span><span class="p">(</span><span class="n">socket_instance</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">OutputConsumer</span><span class="p">(</span><span class="n">CompatThread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Thread that consumes output</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OutputConsumer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span> <span class="o">=</span> <span class="n">redirect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redirect</span><span class="p">,</span> <span class="n">Queue</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redirect_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipe_queue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redirect</span><span class="p">,</span> <span class="n">deque</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redirect_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipe_deque</span>
        <span class="k">if</span> <span class="n">hasattr2</span><span class="p">(</span><span class="n">redirect</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redirect_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipe_fd</span>

    <span class="k">def</span> <span class="nf">_pipe_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pipe_deque</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pipe_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="n">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines_iterator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redirect_func</span><span class="p">(</span><span class="n">smart_decode</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ProcessConsumer</span><span class="p">(</span><span class="n">CompatThread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Thread that ensures process stdout and stderr are properly closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">closable_list</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProcessConsumer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">proc</span>
        <span class="k">if</span> <span class="n">closable_list</span><span class="p">:</span>
            <span class="c1"># We don&#39;t care if it contains queues or deques, quiet_close will</span>
            <span class="c1"># just ignore them.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closable_list</span> <span class="o">=</span> <span class="n">closable_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closable_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">quiet_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">quiet_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">closable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">closable_list</span><span class="p">:</span>
            <span class="n">quiet_close</span><span class="p">(</span><span class="n">closable</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GatewayParameters</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper class that contains all parameters that can be passed to</span>
<span class="sd">    configure a `JavaGateway`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">DEFAULT_ADDRESS</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">DEFAULT_PORT</span><span class="p">,</span> <span class="n">auto_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">auto_close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_convert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eager_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ssl_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enable_memory_management</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">read_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param address: the address to which the client will request a</span>
<span class="sd">            connection. If you&#39;re assing a `SSLContext` with</span>
<span class="sd">            `check_hostname=True` then this address must match</span>
<span class="sd">            (one of) the hostname(s) in the certificate the gateway</span>
<span class="sd">            server presents.</span>

<span class="sd">        :param port: the port to which the client will request a connection.</span>
<span class="sd">            Default is 25333.</span>

<span class="sd">        :param auto_field: if `False`, each object accessed through this</span>
<span class="sd">            gateway won&quot;t try to lookup fields (they will be accessible only by</span>
<span class="sd">            calling get_field). If `True`, fields will be automatically looked</span>
<span class="sd">            up, possibly hiding methods of the same name and making method</span>
<span class="sd">            calls less efficient.</span>

<span class="sd">        :param auto_close: if `True`, the connections created by the client</span>
<span class="sd">            close the socket when they are garbage collected.</span>

<span class="sd">        :param auto_convert: if `True`, try to automatically convert Python</span>
<span class="sd">            objects like sequences and maps to Java Objects. Default value is</span>
<span class="sd">            `False` to improve performance and because it is still possible to</span>
<span class="sd">            explicitly perform this conversion.</span>

<span class="sd">        :param eager_load: if `True`, the gateway tries to connect to the JVM</span>
<span class="sd">            by calling System.currentTimeMillis. If the gateway cannot connect</span>
<span class="sd">            to the JVM, it shuts down itself and raises an exception.</span>

<span class="sd">        :param ssl_context: if not None, SSL connections will be made using</span>
<span class="sd">            this SSLContext</span>

<span class="sd">        :param enable_memory_management: if True, tells the Java side when a</span>
<span class="sd">            JavaObject (reference to an object on the Java side) is garbage</span>
<span class="sd">            collected on the Python side.</span>

<span class="sd">        :param read_timeout: if &gt; 0, sets a timeout in seconds after</span>
<span class="sd">            which the socket stops waiting for a response from the Java side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_field</span> <span class="o">=</span> <span class="n">auto_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_close</span> <span class="o">=</span> <span class="n">auto_close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_convert</span> <span class="o">=</span> <span class="n">auto_convert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eager_load</span> <span class="o">=</span> <span class="n">eager_load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_memory_management</span> <span class="o">=</span> <span class="n">enable_memory_management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_timeout</span> <span class="o">=</span> <span class="n">read_timeout</span>


<span class="k">class</span> <span class="nc">CallbackServerParameters</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper class that contains all parameters that can be passed to</span>
<span class="sd">    configure a `CallbackServer`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">DEFAULT_ADDRESS</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">DEFAULT_PYTHON_PROXY_PORT</span><span class="p">,</span>
            <span class="n">daemonize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">daemonize_connections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eager_load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ssl_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">accept_timeout</span><span class="o">=</span><span class="n">DEFAULT_ACCEPT_TIMEOUT_PLACEHOLDER</span><span class="p">,</span>
            <span class="n">read_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param address: the address to which the client will request a</span>
<span class="sd">            connection</span>

<span class="sd">        :param port: the port to which the client will request a connection.</span>
<span class="sd">            Default is 25333.</span>

<span class="sd">        :param daemonize: If `True`, will set the daemon property of the server</span>
<span class="sd">            thread to True. The callback server will exit automatically if all</span>
<span class="sd">            the other threads exit.</span>

<span class="sd">        :param daemonize_connections: If `True`, callback server connections</span>
<span class="sd">            are executed in daemonized threads and will not block the exit of a</span>
<span class="sd">            program if non daemonized threads are finished.</span>

<span class="sd">        :param eager_load: If `True`, the callback server is automatically</span>
<span class="sd">            started when the JavaGateway is created.</span>

<span class="sd">        :param ssl_context: if not None, the SSLContext&#39;s certificate will be</span>
<span class="sd">         presented to callback connections.</span>

<span class="sd">        :param accept_timeout: if &gt; 0, sets a timeout in seconds after which</span>
<span class="sd">            the callbackserver stops waiting for a connection, sees if the</span>
<span class="sd">            callback server should shut down, and if not, wait again for a</span>
<span class="sd">            connection. The default is 5 seconds: this roughly means that</span>
<span class="sd">            if can take up to 5 seconds to shut down the callback server.</span>

<span class="sd">        :param read_timeout: if &gt; 0, sets a timeout in seconds after</span>
<span class="sd">            which the socket stops waiting for a call or command from the</span>
<span class="sd">            Java side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemonize</span> <span class="o">=</span> <span class="n">daemonize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemonize_connections</span> <span class="o">=</span> <span class="n">daemonize_connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eager_load</span> <span class="o">=</span> <span class="n">eager_load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl_context</span>
        <span class="k">if</span> <span class="n">accept_timeout</span> <span class="o">==</span> <span class="n">DEFAULT_ACCEPT_TIMEOUT_PLACEHOLDER</span><span class="p">:</span>
            <span class="c1"># This is to support deprecated function call...</span>
            <span class="c1"># TODO Remove &quot;DEFAULT&quot; once we remove the deprecated function</span>
            <span class="c1"># call.</span>
            <span class="n">accept_timeout</span> <span class="o">=</span> <span class="n">DEFAULT_CALLBACK_SERVER_ACCEPT_TIMEOUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accept_timeout</span> <span class="o">=</span> <span class="n">accept_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_timeout</span> <span class="o">=</span> <span class="n">read_timeout</span>


<span class="k">class</span> <span class="nc">DummyRLock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">GatewayConnectionGuard</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">connection</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hint</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">_give_back_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">GatewayClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Responsible for managing connections to the JavaGateway.</span>

<span class="sd">    This implementation is thread-safe and connections are created on-demand.</span>
<span class="sd">    This means that Py4J-Python can be accessed by multiple threads and</span>
<span class="sd">    messages are sent to and processed concurrently by the Java Gateway.</span>

<span class="sd">    When creating a custom :class:`JavaGateway`, it is recommended to pass an</span>
<span class="sd">    instance of :class:`GatewayClient` instead of a :class:`GatewayConnection`:</span>
<span class="sd">    both have the same interface, but the client supports multiple threads and</span>
<span class="sd">    connections, which is essential when using callbacks.  &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">DEFAULT_ADDRESS</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">DEFAULT_PORT</span><span class="p">,</span>
            <span class="n">auto_close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gateway_property</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ssl_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gateway_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param gateway_parameters: the set of parameters used to configure the</span>
<span class="sd">            GatewayClient.</span>

<span class="sd">        :param gateway_property: used to keep gateway preferences without a</span>
<span class="sd">            cycle with the gateway</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="o">!=</span> <span class="n">DEFAULT_ADDRESS</span><span class="p">:</span>
            <span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;GatewayClient.address&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;GatewayParameters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">port</span> <span class="o">!=</span> <span class="n">DEFAULT_PORT</span><span class="p">:</span>
            <span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;GatewayClient.port&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;GatewayParameters&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gateway_parameters</span><span class="p">:</span>
            <span class="n">gateway_parameters</span> <span class="o">=</span> <span class="n">GatewayParameters</span><span class="p">(</span>
                <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">auto_close</span><span class="o">=</span><span class="n">auto_close</span><span class="p">,</span>
                <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span> <span class="o">=</span> <span class="n">gateway_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_close</span> <span class="o">=</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">auto_close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_property</span> <span class="o">=</span> <span class="n">gateway_property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_context</span> <span class="o">=</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">ssl_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deque</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Py4JNetworkError</span><span class="p">(</span><span class="s2">&quot;Gateway is not connected.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deque</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_connection</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">connection</span>

    <span class="k">def</span> <span class="nf">_create_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">GatewayConnection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_property</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">connection</span>

    <span class="k">def</span> <span class="nf">_give_back_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deque</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Exception while giving back connection&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shutdown_gateway</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends a shutdown command to the gateway. This will close the</span>
<span class="sd">           gateway server: all active connections will be closed. This may</span>
<span class="sd">           be useful if the lifecycle of the Java program must be tied to</span>
<span class="sd">           the Python program.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">shutdown_gateway</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">Py4JNetworkError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Error while shutting down gateway.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_gateway</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends a command to the JVM. This method is not intended to be</span>
<span class="sd">           called directly by Py4J users. It is usually called by</span>
<span class="sd">           :class:`JavaMember` instances.</span>

<span class="sd">        :param command: the `string` command to send to the JVM. The command</span>
<span class="sd">         must follow the Py4J protocol.</span>

<span class="sd">        :param retry: if `True`, the GatewayClient tries to resend a message</span>
<span class="sd">         if it fails.</span>

<span class="sd">        :param binary: if `True`, we won&#39;t wait for a Py4J-protocol response</span>
<span class="sd">         from the other end; we&#39;ll just return the raw connection to the</span>
<span class="sd">         caller. The caller becomes the owner of the connection, and is</span>
<span class="sd">         responsible for closing the connection (or returning it this</span>
<span class="sd">         `GatewayClient` pool using `_give_back_connection`).</span>

<span class="sd">        :rtype: the `string` answer received from the JVM (The answer follows</span>
<span class="sd">         the Py4J protocol). The guarded `GatewayConnection` is also returned</span>
<span class="sd">         if `binary` is `True`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_connection_guard</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_give_back_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Py4JNetworkError</span> <span class="k">as</span> <span class="n">pne</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">connection</span><span class="p">:</span>
                <span class="n">reset</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pne</span><span class="o">.</span><span class="n">cause</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
                    <span class="n">reset</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">reset</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_retry</span><span class="p">(</span><span class="n">retry</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">pne</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exception while sending command.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="n">binary</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s2">&quot;Exception while sending command.&quot;</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">ERROR</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">_create_connection_guard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GatewayConnectionGuard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_should_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">pne</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pne</span> <span class="ow">and</span> <span class="n">pne</span><span class="o">.</span><span class="n">when</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">ERROR_ON_SEND</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes all currently opened connections.</span>

<span class="sd">        This operation is not thread safe and is only a best effort strategy</span>
<span class="sd">        to close active connections.</span>

<span class="sd">        All connections are guaranteed to be closed only if no other thread</span>
<span class="sd">        is accessing the client and no call is pending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deque</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deque</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">quiet_close</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>


<span class="k">class</span> <span class="nc">GatewayConnection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default gateway connection (socket based) responsible for communicating</span>
<span class="sd">       with the Java Virtual Machine.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gateway_parameters</span><span class="p">,</span> <span class="n">gateway_property</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param gateway_parameters: the set of parameters used to configure the</span>
<span class="sd">            GatewayClient.</span>

<span class="sd">        :param gateway_property: contains gateway preferences to avoid a cycle</span>
<span class="sd">         with gateway</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span> <span class="o">=</span> <span class="n">gateway_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">port</span>
        <span class="n">af_type</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">af_type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">read_timeout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">gateway_parameters</span><span class="o">.</span><span class="n">read_timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">ssl_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">ssl_context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_close</span> <span class="o">=</span> <span class="n">gateway_parameters</span><span class="o">.</span><span class="n">auto_close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_property</span> <span class="o">=</span> <span class="n">gateway_property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">wr</span><span class="p">,</span> <span class="n">socket_instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
            <span class="n">_garbage_collect_connection</span> <span class="ow">and</span>
            <span class="n">_garbage_collect_connection</span><span class="p">(</span><span class="n">socket_instance</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the connection by connecting to the `address` and the `port`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;An error occurred while trying to connect to the Java &quot;</span>\
                <span class="s2">&quot;server (</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">Py4JNetworkError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes the connection by closing the socket.</span>

<span class="sd">        If reset is True, sends a RST packet with SO_LINGER</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">set_linger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sent shut down before attempting to close a stream or socket.</span>
            <span class="n">quiet_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="n">quiet_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
        <span class="n">quiet_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">shutdown_gateway</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends a shutdown command to the gateway. This will close the gateway</span>
<span class="sd">           server: all active connections will be closed. This may be useful</span>
<span class="sd">           if the lifecycle of the Java program must be tied to the Python</span>
<span class="sd">           program.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span><span class="s2">&quot;Gateway must be connected to send shutdown cmd.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">quiet_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span>
                <span class="n">proto</span><span class="o">.</span><span class="n">SHUTDOWN_GATEWAY_COMMAND_NAME</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="n">quiet_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Do nothing! Exceptions might occur anyway.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception occurred while shutting down gateway&quot;</span><span class="p">,</span>
                         <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends a command to the JVM. This method is not intended to be</span>
<span class="sd">           called directly by Py4J users: it is usually called by JavaMember</span>
<span class="sd">           instances.</span>

<span class="sd">        :param command: the `string` command to send to the JVM. The command</span>
<span class="sd">         must follow the Py4J protocol.</span>

<span class="sd">        :rtype: the `string` answer received from the JVM (The answer follows</span>
<span class="sd">         the Py4J protocol).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Command to send: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Write will only fail if remote is closed for large payloads or</span>
            <span class="c1"># if it sent a RST packet (SO_LINGER)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error while sending.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">Py4JNetworkError</span><span class="p">(</span>
                <span class="s2">&quot;Error while sending&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">proto</span><span class="o">.</span><span class="n">ERROR_ON_SEND</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">smart_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Answer received: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">answer</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">RETURN_MESSAGE</span><span class="p">):</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="n">answer</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c1"># Happens when a the other end is dead. There might be an empty</span>
            <span class="c1"># answer before the socket raises an error.</span>
            <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Py4JNetworkError</span><span class="p">(</span><span class="s2">&quot;Answer from Java side is empty&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">answer</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error while receiving.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">Py4JNetworkError</span><span class="p">(</span>
                <span class="s2">&quot;Error while receiving&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">proto</span><span class="o">.</span><span class="n">ERROR_ON_RECEIVE</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">JavaMember</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a member (i.e., method) of a :class:`JavaObject`. For now,</span>
<span class="sd">       only methods are supported. Fields are retrieved directly and are not</span>
<span class="sd">       contained in a JavaMember.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">target_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span> <span class="o">=</span> <span class="n">gateway_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="o">.</span><span class="n">gateway_property</span><span class="o">.</span><span class="n">pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="o">.</span><span class="n">converters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__doc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The __doc__ string is used by IPython/PyDev/etc to generate</span>
        <span class="c1"># help string, therefore provide useful help</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span> <span class="o">=</span> <span class="n">gateway_help</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span>

    <span class="k">def</span> <span class="nf">_get_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">temp_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">JavaObject</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">converter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="o">.</span><span class="n">converters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">converter</span><span class="o">.</span><span class="n">can_convert</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                        <span class="n">temp_arg</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="p">)</span>
                        <span class="n">temp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_arg</span><span class="p">)</span>
                        <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_arg</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">new_args</span><span class="p">,</span> <span class="n">temp_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">new_args</span><span class="p">,</span> <span class="n">temp_args</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">temp_args</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">args_command</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">get_command_part</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">new_args</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">args_command</span><span class="p">,</span> <span class="n">temp_args</span>

    <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call the method using the &#39;binary&#39; protocol.</span>

<span class="sd">        :rtype: The `GatewayConnection` that the call command was sent to.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">args_command</span><span class="p">,</span> <span class="n">temp_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">STREAM_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">command_header</span> <span class="o">+</span>\
            <span class="n">args_command</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>
        <span class="n">answer</span><span class="p">,</span> <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
            <span class="n">command</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># parse the return value to throw an exception if necessary</span>
        <span class="n">get_return_value</span><span class="p">(</span>
            <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">temp_arg</span> <span class="ow">in</span> <span class="n">temp_args</span><span class="p">:</span>
            <span class="n">temp_arg</span><span class="o">.</span><span class="n">_detach</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">connection</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">args_command</span><span class="p">,</span> <span class="n">temp_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">CALL_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">command_header</span> <span class="o">+</span>\
            <span class="n">args_command</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span>
            <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">temp_arg</span> <span class="ow">in</span> <span class="n">temp_args</span><span class="p">:</span>
            <span class="n">temp_arg</span><span class="o">.</span><span class="n">_detach</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">return_value</span>


<div class="viewcode-block" id="JavaObject"><a class="viewcode-back" href="../../generated/generated/pyspark.mllib.linalg.distributed.JavaObject.html#pyspark.ml.param.JavaObject">[docs]</a><span class="k">class</span> <span class="nc">JavaObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a Java object from which you can call methods or access</span>
<span class="sd">       fields.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="JavaObject.__init__"><a class="viewcode-back" href="../../generated/generated/pyspark.mllib.linalg.distributed.JavaObject.__init__.html#pyspark.ml.param.JavaObject.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param target_id: the identifier of the object on the JVM side. Given</span>
<span class="sd">         by the JVM.</span>

<span class="sd">        :param gateway_client: the gateway client used to communicate with</span>
<span class="sd">         the JVM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span> <span class="o">=</span> <span class="n">target_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span> <span class="o">=</span> <span class="n">gateway_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_field</span> <span class="o">=</span> <span class="n">gateway_client</span><span class="o">.</span><span class="n">gateway_property</span><span class="o">.</span><span class="n">auto_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fully_populated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">smart_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">address</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">smart_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">gateway_property</span><span class="o">.</span><span class="n">enable_memory_management</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">wr</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span><span class="p">:</span>
                <span class="n">_garbage_collect_object</span> <span class="ow">and</span> <span class="n">_garbage_collect_object</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span>

            <span class="n">ThreadSafeFinalizer</span><span class="o">.</span><span class="n">add_finalizer</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_garbage_collect_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_object_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__doc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The __doc__ string is used by IPython/PyDev/etc to generate</span>
        <span class="c1"># help string, therefore provide useful help</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span> <span class="o">=</span> <span class="n">gateway_help</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__call__&quot;</span><span class="p">:</span>
            <span class="c1"># Provide an explicit definition for __call__ so that a JavaMember</span>
            <span class="c1"># does not get created for it. This serves two purposes:</span>
            <span class="c1"># 1) IPython (and others?) stop showing incorrect help indicating</span>
            <span class="c1">#    that this is callable</span>
            <span class="c1"># 2) A TypeError(object not callable) is raised if someone does try</span>
            <span class="c1">#    to call here</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auto_field</span><span class="p">):</span>
                <span class="p">(</span><span class="n">is_field</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_field</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_field_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">return_value</span>
            <span class="c1"># Theoretically, not thread safe, but the worst case scenario is</span>
            <span class="c1"># cache miss or double overwrite of the same method...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">JavaMember</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>

        <span class="c1"># The name is a method</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_fields</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_populate_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Theoretically, not thread safe, but the worst case scenario is</span>
        <span class="c1"># cache miss or double overwrite of the same method...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fully_populated</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_field</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">DIR_COMMAND_NAME</span> <span class="o">+</span>\
                    <span class="n">proto</span><span class="o">.</span><span class="n">DIR_FIELDS_SUBCOMMAND_NAME</span> <span class="o">+</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
                    <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>

                <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span>
                    <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span><span class="p">,</span> <span class="s2">&quot;__dir__&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_field_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">return_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>

            <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">DIR_COMMAND_NAME</span> <span class="o">+</span>\
                <span class="n">proto</span><span class="o">.</span><span class="n">DIR_METHODS_SUBCOMMAND_NAME</span> <span class="o">+</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
                <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>

            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span>
                <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span><span class="p">,</span> <span class="s2">&quot;__dir__&quot;</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">return_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">JavaMember</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_fully_populated</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">FIELD_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">FIELD_GET_SUBCOMMAND_NAME</span> <span class="o">+</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">NO_MEMBER_COMMAND</span> <span class="ow">or</span> <span class="n">is_error</span><span class="p">(</span><span class="n">answer</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span>
                <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">hasattr2</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;_get_object_id&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashCode</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># For now...</span>
        <span class="k">return</span> <span class="s2">&quot;JavaObject id=&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_id</span></div>


<div class="viewcode-block" id="JavaClass"><a class="viewcode-back" href="../../generated/generated/pyspark.sql.types.JavaClass.html#pyspark.ml.param.JavaClass">[docs]</a><span class="k">class</span> <span class="nc">JavaClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `JavaClass` represents a Java Class from which static members can be</span>
<span class="sd">       retrieved. `JavaClass` instances are also needed to initialize an array.</span>

<span class="sd">       Usually, `JavaClass` are not initialized using their constructor, but</span>
<span class="sd">       they are created while accessing the `jvm` property of a gateway, e.g.,</span>
<span class="sd">       `gateway.jvm.java.lang.String`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="JavaClass.__init__"><a class="viewcode-back" href="../../generated/generated/pyspark.sql.types.JavaClass.__init__.html#pyspark.ml.param.JavaClass.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fqn</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span> <span class="o">=</span> <span class="n">fqn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span> <span class="o">=</span> <span class="n">gateway_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">gateway_property</span><span class="o">.</span><span class="n">pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command_header</span> <span class="o">=</span> <span class="n">fqn</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_converters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">converters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statics</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__doc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The __doc__ string is used by IPython/PyDev/etc to generate</span>
        <span class="c1"># help string, therefore provide useful help</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span> <span class="o">=</span> <span class="n">gateway_help</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_doc</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Theoretically, not thread safe, but the worst case scenario is</span>
        <span class="c1"># cache miss or double overwrite of the same method...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">DIR_COMMAND_NAME</span> <span class="o">+</span>\
                <span class="n">proto</span><span class="o">.</span><span class="n">DIR_STATIC_SUBCOMMAND_NAME</span> <span class="o">+</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
                <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>

            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span>
                <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span><span class="p">,</span> <span class="s2">&quot;__dir__&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_statics</span> <span class="o">=</span> <span class="n">return_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statics</span><span class="p">[:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_java_lang_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the java.lang.Class of the current JavaClass. This is</span>
<span class="sd">        equivalent to calling .class in Java.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">REFLECTION_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">REFL_GET_JAVA_LANG_CLASS_SUB_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">answer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_return_value</span><span class="p">(</span>
                <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span><span class="p">,</span> <span class="s2">&quot;_java_lang_class&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> does not exist in the JVM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;__str__&quot;</span><span class="p">,</span> <span class="s2">&quot;__repr__&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">REFLECTION_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">REFL_GET_MEMBER_SUB_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">answer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">METHOD_TYPE</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JavaMember</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">proto</span><span class="o">.</span><span class="n">STATIC_PREFIX</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">answer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">CLASS_TYPE</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">JavaClass</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">get_return_value</span><span class="p">(</span>
                    <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2"> does not exist in the JVM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">temp_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">JavaObject</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">converter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">converter</span><span class="o">.</span><span class="n">can_convert</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                        <span class="n">temp_arg</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>
                        <span class="n">temp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_arg</span><span class="p">)</span>
                        <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_arg</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">new_args</span><span class="p">,</span> <span class="n">temp_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># TODO Refactor to use a mixin shared by JavaMember and JavaClass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_converters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">new_args</span><span class="p">,</span> <span class="n">temp_args</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">temp_args</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">args_command</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">get_command_part</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">new_args</span><span class="p">])</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">CONSTRUCTOR_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_command_header</span> <span class="o">+</span>\
            <span class="n">args_command</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span>
            <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">temp_arg</span> <span class="ow">in</span> <span class="n">temp_args</span><span class="p">:</span>
            <span class="n">temp_arg</span><span class="o">.</span><span class="n">_detach</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">return_value</span></div>


<span class="k">class</span> <span class="nc">UserHelpAutoCompletion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Type a package name or a class name.</span>

<span class="sd">    For example with a JVMView called view:</span>
<span class="sd">    &gt;&gt;&gt; o = view.Object() # create a java.lang.Object</span>
<span class="sd">    &gt;&gt;&gt; random = view.jvm.java.util.Random() # create a java.util.Random</span>

<span class="sd">    The default JVMView is in the gateway and is called:</span>
<span class="sd">    &gt;&gt;&gt; gateway.jvm</span>

<span class="sd">    By default, java.lang.* is available in the view. To</span>
<span class="sd">    add additional Classes/Packages, do:</span>
<span class="sd">    &gt;&gt;&gt; from py4j.java_gateway import java_import</span>
<span class="sd">    &gt;&gt;&gt; java_import(gateway.jvm, &quot;com.example.Class1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; instance = gateway.jvm.Class1()</span>

<span class="sd">    Package and class completions are only available for</span>
<span class="sd">    explicitly imported Java classes. For example, if you</span>
<span class="sd">    java_import(gateway.jvm, &quot;com.example.Class1&quot;)</span>
<span class="sd">    then Class1 will appear in the completions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">KEY</span> <span class="o">=</span> <span class="s2">&quot;&lt;package or class name&gt;&quot;</span>


<span class="k">class</span> <span class="nc">JavaPackage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `JavaPackage` represents part of a Java package from which Java</span>
<span class="sd">       classes can be accessed.</span>

<span class="sd">       Usually, `JavaPackage` are not initialized using their constructor, but</span>
<span class="sd">       they are created while accessing the `jvm` property of a gateway, e.g.,</span>
<span class="sd">       `gateway.jvm.java.lang`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fqn</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">,</span> <span class="n">jvm_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span> <span class="o">=</span> <span class="n">fqn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span> <span class="o">=</span> <span class="n">gateway_client</span>
        <span class="k">if</span> <span class="n">jvm_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jvm_id</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">DEFAULT_JVM_ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jvm_id</span> <span class="o">=</span> <span class="n">jvm_id</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">UserHelpAutoCompletion</span><span class="o">.</span><span class="n">KEY</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">UserHelpAutoCompletion</span><span class="o">.</span><span class="n">KEY</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UserHelpAutoCompletion</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;__str__&quot;</span><span class="p">,</span> <span class="s2">&quot;__repr__&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__call__&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span><span class="s2">&quot;Trying to call a package.&quot;</span><span class="p">)</span>
        <span class="n">new_fqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">REFLECTION_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">REFL_GET_UNKNOWN_SUB_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">new_fqn</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_jvm_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">SUCCESS_PACKAGE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JavaPackage</span><span class="p">(</span><span class="n">new_fqn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jvm_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">answer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">SUCCESS_CLASS</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JavaClass</span><span class="p">(</span>
                <span class="n">answer</span><span class="p">[</span><span class="n">proto</span><span class="o">.</span><span class="n">CLASS_FQN_START</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> does not exist in the JVM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_fqn</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">JVMView</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `JVMView` allows access to the Java Virtual Machine of a</span>
<span class="sd">       `JavaGateway`.</span>

<span class="sd">       This can be used to reference static members (fields and methods) and</span>
<span class="sd">       to call constructors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">,</span> <span class="n">jvm_name</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jvm_object</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span> <span class="o">=</span> <span class="n">gateway_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jvm_name</span> <span class="o">=</span> <span class="n">jvm_name</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="k">elif</span> <span class="n">jvm_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">REFERENCE_TYPE</span> <span class="o">+</span> <span class="n">jvm_object</span><span class="o">.</span><span class="n">_get_object_id</span><span class="p">()</span>
            <span class="c1"># So that both JVMView instances (on Python and Java) have the</span>
            <span class="c1"># same lifecycle. Theoretically, JVMView could inherit from</span>
            <span class="c1"># JavaObject, but I would like to avoid the use of reflection</span>
            <span class="c1"># for regular Py4J classes.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jvm_object</span> <span class="o">=</span> <span class="n">jvm_object</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_sequence_and_cache</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">DIR_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">DIR_JVMVIEW_SUBCOMMAND_NAME</span> <span class="o">+</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="n">get_command_part</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_sequence_and_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span>
            <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fqn</span><span class="p">,</span> <span class="s2">&quot;__dir__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">return_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Theoretically, not thread safe, but the worst case scenario is</span>
            <span class="c1"># cache miss or double overwrite of the same method...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir_sequence_and_cache</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">UserHelpAutoCompletion</span><span class="o">.</span><span class="n">KEY</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_sequence_and_cache</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">UserHelpAutoCompletion</span><span class="o">.</span><span class="n">KEY</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UserHelpAutoCompletion</span><span class="p">()</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
            <span class="n">proto</span><span class="o">.</span><span class="n">REFLECTION_COMMAND_NAME</span> <span class="o">+</span>
            <span class="n">proto</span><span class="o">.</span><span class="n">REFL_GET_UNKNOWN_SUB_COMMAND_NAME</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">+</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">SUCCESS_PACKAGE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JavaPackage</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="n">jvm_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">answer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">SUCCESS_CLASS</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JavaClass</span><span class="p">(</span>
                <span class="n">answer</span><span class="p">[</span><span class="n">proto</span><span class="o">.</span><span class="n">CLASS_FQN_START</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> does not exist in the JVM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">GatewayProperty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Object shared by callbackserver, gateway, and connections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_field</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">enable_memory_management</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_field</span> <span class="o">=</span> <span class="n">auto_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_memory_management</span> <span class="o">=</span> <span class="n">enable_memory_management</span>


<span class="k">class</span> <span class="nc">JavaGateway</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `JavaGateway` is the main interaction point between a Python VM and</span>
<span class="sd">       a JVM.</span>

<span class="sd">    * A `JavaGateway` instance is connected to a `Gateway` instance on the</span>
<span class="sd">      Java side.</span>

<span class="sd">    * The `entry_point` field of a `JavaGateway` instance is connected to</span>
<span class="sd">      the `Gateway.entryPoint` instance on the Java side.</span>

<span class="sd">    * The `java_gateway_server` field of a `JavaGateway` instance is connected</span>
<span class="sd">      to the `GatewayServer` instance on the Java side.</span>

<span class="sd">    * The `jvm` field of `JavaGateway` enables user to access classes, static</span>
<span class="sd">      members (fields and methods) and call constructors.</span>

<span class="sd">    Methods that are not defined by `JavaGateway` are always redirected to</span>
<span class="sd">    `entry_point`. For example, ``gateway.doThat()`` is equivalent to</span>
<span class="sd">    ``gateway.entry_point.doThat()``. This is a trade-off between convenience</span>
<span class="sd">    and potential confusion.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">gateway_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">python_proxy_port</span><span class="o">=</span><span class="n">DEFAULT_PYTHON_PROXY_PORT</span><span class="p">,</span>
            <span class="n">start_callback_server</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_convert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eager_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">gateway_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback_server_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">python_server_entry_point</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param gateway_parameters: An instance of `GatewayParameters` used to</span>
<span class="sd">            configure the various options of the gateway.</span>

<span class="sd">        :param callback_server_parameters: An instance of</span>
<span class="sd">            `CallbackServerParameters` used to configure various options of the</span>
<span class="sd">            gateway server. Must be provided to start a gateway server.</span>
<span class="sd">            Otherwise, callbacks won&quot;t be available.</span>

<span class="sd">        :param python_server_entry_point: can be requested by the Java side if</span>
<span class="sd">            Java is driving the communication.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span> <span class="o">=</span> <span class="n">gateway_parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gateway_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span> <span class="o">=</span> <span class="n">GatewayParameters</span><span class="p">(</span>
                <span class="n">auto_field</span><span class="o">=</span><span class="n">auto_field</span><span class="p">,</span> <span class="n">auto_convert</span><span class="o">=</span><span class="n">auto_convert</span><span class="p">,</span>
                <span class="n">eager_load</span><span class="o">=</span><span class="n">eager_load</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span> <span class="o">=</span> <span class="n">callback_server_parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callback_server_parameters</span><span class="p">:</span>
            <span class="c1"># No parameters were provided so do not autostart callback server.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span> <span class="o">=</span> <span class="n">CallbackServerParameters</span><span class="p">(</span>
                <span class="n">port</span><span class="o">=</span><span class="n">python_proxy_port</span><span class="p">,</span> <span class="n">eager_load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Check for deprecation warnings</span>
        <span class="k">if</span> <span class="n">auto_field</span><span class="p">:</span>
            <span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;JavaGateway.auto_field&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;GatewayParameters&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">auto_convert</span><span class="p">:</span>
            <span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;JavaGateway.auto_convert&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;GatewayParameters&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eager_load</span><span class="p">:</span>
            <span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;JavaGateway.eager_load&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;GatewayParameters&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start_callback_server</span><span class="p">:</span>
            <span class="n">deprecated</span><span class="p">(</span>
                <span class="s2">&quot;JavaGateway.start_callback_server and python_proxy_port&quot;</span><span class="p">,</span>
                <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;CallbackServerParameters&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">eager_load</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">gateway_client</span><span class="p">:</span>
            <span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;JavaGateway.gateway_client&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;GatewayParameters&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gateway_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_gateway_client</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">python_server_entry_point</span> <span class="o">=</span> <span class="n">python_server_entry_point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_proxy_port</span> <span class="o">=</span> <span class="n">python_proxy_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_property</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_gateway_property</span><span class="p">()</span>

        <span class="c1"># Setup gateway client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_gateway_client</span><span class="p">(</span><span class="n">gateway_client</span><span class="p">)</span>

        <span class="c1"># Setup callback server property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span><span class="o">.</span><span class="n">eager_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eager_load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">eager_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_callback_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_gateway_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gateway_client</span> <span class="o">=</span> <span class="n">GatewayClient</span><span class="p">(</span>
            <span class="n">gateway_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gateway_client</span>

    <span class="k">def</span> <span class="nf">_create_gateway_property</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gateway_property</span> <span class="o">=</span> <span class="n">GatewayProperty</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span><span class="o">.</span><span class="n">auto_field</span><span class="p">,</span> <span class="n">PythonProxyPool</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span><span class="o">.</span><span class="n">enable_memory_management</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_server_entry_point</span><span class="p">:</span>
            <span class="n">gateway_property</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">python_server_entry_point</span><span class="p">,</span> <span class="n">proto</span><span class="o">.</span><span class="n">ENTRY_POINT_OBJECT_ID</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gateway_property</span>

    <span class="k">def</span> <span class="nf">set_gateway_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the gateway client for this JavaGateway. This sets the</span>
<span class="sd">        appropriate gateway_property and resets the main jvm view (self.jvm).</span>

<span class="sd">        This is for advanced usage only. And should only be set before the</span>
<span class="sd">        gateway is loaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_parameters</span><span class="o">.</span><span class="n">auto_convert</span><span class="p">:</span>
            <span class="n">gateway_client</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">INPUT_CONVERTER</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gateway_client</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gateway_client</span><span class="o">.</span><span class="n">gateway_property</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span> <span class="o">=</span> <span class="n">gateway_client</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">JavaObject</span><span class="p">(</span>
            <span class="n">proto</span><span class="o">.</span><span class="n">ENTRY_POINT_OBJECT_ID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">java_gateway_server</span> <span class="o">=</span> <span class="n">JavaObject</span><span class="p">(</span>
            <span class="n">proto</span><span class="o">.</span><span class="n">GATEWAY_SERVER_OBJECT_ID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jvm</span> <span class="o">=</span> <span class="n">JVMView</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="n">jvm_name</span><span class="o">=</span><span class="n">proto</span><span class="o">.</span><span class="n">DEFAULT_JVM_NAME</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">proto</span><span class="o">.</span><span class="n">DEFAULT_JVM_ID</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_eager_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">get_callback_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span>

    <span class="k">def</span> <span class="nf">start_callback_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_server_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the callback server.</span>

<span class="sd">        :param callback_server_parameters: parameters to use to start the</span>
<span class="sd">            server. If not provided, it will use the gateway callback server</span>
<span class="sd">            parameters.</span>

<span class="sd">        :rtype: Returns True if the server was started by this call or False if</span>
<span class="sd">            it was already started (you cannot have more than one started</span>
<span class="sd">            callback server).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">callback_server_parameters</span><span class="p">:</span>
            <span class="n">callback_server_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_callback_server</span><span class="p">(</span>
            <span class="n">callback_server_parameters</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Py4JNetworkError</span><span class="p">:</span>
            <span class="c1"># Clean up ourselves before raising the exception.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_create_callback_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_server_parameters</span><span class="p">):</span>
        <span class="n">callback_server</span> <span class="o">=</span> <span class="n">CallbackServer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gateway_property</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span>
            <span class="n">callback_server_parameters</span><span class="o">=</span><span class="n">callback_server_parameters</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">callback_server</span>

    <span class="k">def</span> <span class="nf">new_jvm_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;custom jvm&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new JVM view with its own imports. A JVM view ensures</span>
<span class="sd">        that the import made in one view does not conflict with the import</span>
<span class="sd">        of another view.</span>

<span class="sd">        Generally, each Python module should have its own view (to replicate</span>
<span class="sd">        Java behavior).</span>

<span class="sd">        :param name: Optional name of the jvm view. Does not need to be</span>
<span class="sd">            unique, i.e., two distinct views can have the same name</span>
<span class="sd">            (internally, they will have a distinct id).</span>

<span class="sd">        :rtype: A JVMView instance (same class as the gateway.jvm instance).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">JVMVIEW_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">JVM_CREATE_VIEW_SUB_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">get_command_part</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">java_object</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JVMView</span><span class="p">(</span>
            <span class="n">gateway_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="n">jvm_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">jvm_object</span><span class="o">=</span><span class="n">java_object</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">java_class</span><span class="p">,</span> <span class="o">*</span><span class="n">dimensions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a Java array of type `java_class` of `dimensions`</span>

<span class="sd">        :param java_class: The :class:`JavaClass` instance representing the</span>
<span class="sd">            type of the array.</span>

<span class="sd">        :param dimensions: A list of dimensions of the array. For example</span>
<span class="sd">            `[1,2]` would produce an `array[1][2]`.</span>

<span class="sd">        :rtype: A :class:`JavaArray &lt;py4j.java_collections.JavaArray&gt;`</span>
<span class="sd">            instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span><span class="s2">&quot;new arrays must have at least one dimension&quot;</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">ARRAY_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">proto</span><span class="o">.</span><span class="n">ARRAY_CREATE_SUB_COMMAND_NAME</span> <span class="o">+</span>\
            <span class="n">get_command_part</span><span class="p">(</span><span class="n">java_class</span><span class="o">.</span><span class="n">_fqn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="n">get_command_part</span><span class="p">(</span><span class="n">dimension</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">+=</span> <span class="n">proto</span><span class="o">.</span><span class="n">END_COMMAND_PART</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_return_value</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shuts down the :class:`GatewayClient` and the</span>
<span class="sd">           :class:`CallbackServer &lt;py4j.java_callback.CallbackServer&gt;`.</span>

<span class="sd">        :param raise_exception: If `True`, raise an exception if an error</span>
<span class="sd">            occurs while shutting down (very likely with sockets).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">shutdown_gateway</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Exception while shutting down callback server&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_callback_server</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">shutdown_callback_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shuts down the</span>
<span class="sd">           :class:`CallbackServer &lt;py4j.java_callback.CallbackServer&gt;`.</span>

<span class="sd">        :param raise_exception: If `True`, raise an exception if an error</span>
<span class="sd">            occurs while shutting down (very likely with sockets).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Nothing to shutdown</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Exception while shutting down callback server&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close_callback_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes the</span>
<span class="sd">           :class:`CallbackServer &lt;py4j.java_callback.CallbackServer&gt;`</span>
<span class="sd">           connections.</span>

<span class="sd">        :param raise_exception: If `True`, raise an exception if an error</span>
<span class="sd">            occurs while closing the callback server connections</span>
<span class="sd">            (very likely with sockets).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Nothing to shutdown</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Exception while closing callback server&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restart_callback_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shuts down the callback server (if started) and restarts a new one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_callback_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_callback_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">keep_callback_server</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">close_callback_server_connections</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes all gateway connections. A connection will be reopened if</span>
<span class="sd">           necessary (e.g., if a :class:`JavaMethod` is called).</span>

<span class="sd">        :param keep_callback_server: if `True`, the callback server is not</span>
<span class="sd">            shut down. Mutually exclusive with</span>
<span class="sd">            close_callback_server_connections.</span>
<span class="sd">        :param close_callback_server_connections: if `True`, close all</span>
<span class="sd">            callback server connections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_callback_server</span><span class="p">:</span>
            <span class="n">deprecated</span><span class="p">(</span>
                <span class="s2">&quot;JavaGateway.close.keep_callback_server&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;JavaGateway.shutdown_callback_server&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_callback_server</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">close_callback_server_connections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_callback_server</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">java_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes the Java Gateway dereference this object.</span>

<span class="sd">        The equivalent of this method is called when a JavaObject instance</span>
<span class="sd">        is garbage collected on the Python side. This method, or gc.collect()</span>
<span class="sd">        should still be invoked when memory is limited or when too many objects</span>
<span class="sd">        are created on the Java side.</span>

<span class="sd">        :param java_object: The JavaObject instance to dereference (free) on</span>
<span class="sd">            the Java side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">java_object</span><span class="o">.</span><span class="n">_detach</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Displays a help page about a class or an object.</span>

<span class="sd">        :param var: JavaObject, JavaClass or JavaMember for which a help page</span>
<span class="sd">            will be generated.</span>

<span class="sd">        :param pattern: Star-pattern used to filter the members. For example</span>
<span class="sd">            &quot;get\*Foo&quot; may return getMyFoo, getFoo, getFooBar, but not</span>
<span class="sd">            bargetFoo. The pattern is matched against the entire signature.</span>
<span class="sd">            To match only the name of a method, use &quot;methodName(\*&quot;.</span>

<span class="sd">        :param short_name: If True, only the simple name of the parameter</span>
<span class="sd">            types and return types will be displayed. If False, the fully</span>
<span class="sd">            qualified name of the types will be displayed.</span>

<span class="sd">        :param display: If True, the help page is displayed in an interactive</span>
<span class="sd">            page similar to the `help` command in Python. If False, the page is</span>
<span class="sd">            returned as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">gateway_help</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">short_name</span><span class="p">,</span> <span class="n">display</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">launch_gateway</span><span class="p">(</span>
            <span class="n">cls</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">jarpath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">classpath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">javaopts</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">die_on_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">redirect_stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">redirect_stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">daemonize_redirect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">java_path</span><span class="o">=</span><span class="s2">&quot;java&quot;</span><span class="p">,</span>
            <span class="n">create_new_process_group</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Launch a `Gateway` in a new Java process and create a default</span>
<span class="sd">        :class:`JavaGateway &lt;py4j.java_gateway.JavaGateway&gt;` to connect to</span>
<span class="sd">        it.</span>

<span class="sd">        See :func:`launch_gateway &lt;py4j.java_gateway.launch_gateway&gt;` for more</span>
<span class="sd">        information about this function.</span>

<span class="sd">        :param port: the port to launch the Java Gateway on.  If no port is</span>
<span class="sd">            specified then an ephemeral port is used.</span>
<span class="sd">        :param jarpath: the path to the Py4J jar.  Only necessary if the jar</span>
<span class="sd">            was installed at a non-standard location or if Python is using</span>
<span class="sd">            a different `sys.prefix` than the one that Py4J was installed</span>
<span class="sd">            under.</span>
<span class="sd">        :param classpath: the classpath used to launch the Java Gateway.</span>
<span class="sd">        :param javaopts: an array of extra options to pass to Java (the</span>
<span class="sd">            classpath should be specified using the `classpath` parameter,</span>
<span class="sd">            not `javaopts`.)</span>
<span class="sd">        :param die_on_exit: if `True`, the Java gateway process will die when</span>
<span class="sd">            this Python process exits or is killed.</span>
<span class="sd">        :param redirect_stdout: where to redirect the JVM stdout.</span>
<span class="sd">            If None (default)</span>
<span class="sd">            stdout is redirected to os.devnull. Otherwise accepts a</span>
<span class="sd">            file descriptor, a queue, or a deque. Will send one line at a time</span>
<span class="sd">            to these objects.</span>
<span class="sd">        :param redirect_stderr: where to redirect the JVM stdout.</span>
<span class="sd">            If None (default)</span>
<span class="sd">            stderr is redirected to os.devnull. Otherwise accepts a</span>
<span class="sd">            file descriptor, a queue, or a deque. Will send one line at a time</span>
<span class="sd">            to these objects.</span>
<span class="sd">        :param daemonize_redirect: if True, the consumer threads will be</span>
<span class="sd">            daemonized and will not prevent the main Python process from</span>
<span class="sd">            exiting. This means the file descriptors (stderr, stdout,</span>
<span class="sd">            redirect_stderr, redirect_stdout) might not be properly closed.</span>
<span class="sd">            This is not usually a problem, but in case of errors related</span>
<span class="sd">            to file descriptors, set this flag to False.</span>
<span class="sd">        :param java_path: If None, Py4J will use $JAVA_HOME/bin/java if</span>
<span class="sd">            $JAVA_HOME is defined, otherwise it will use &quot;java&quot;.</span>
<span class="sd">        :param create_new_process_group: If True, the JVM is started in a new</span>
<span class="sd">            process group. This ensures that signals sent to the parent Python</span>
<span class="sd">            process are not forwarded to the JVM. For example, sending</span>
<span class="sd">            Ctrl-C/SIGINT won&#39;t interrupt the JVM. If the python process dies,</span>
<span class="sd">            the Java process will stay alive, which may be a problem for some</span>
<span class="sd">            scenarios though.</span>


<span class="sd">        :rtype: a :class:`JavaGateway &lt;py4j.java_gateway.JavaGateway&gt;`</span>
<span class="sd">            connected to the `Gateway` server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_port</span> <span class="o">=</span> <span class="n">launch_gateway</span><span class="p">(</span>
            <span class="n">port</span><span class="p">,</span> <span class="n">jarpath</span><span class="p">,</span> <span class="n">classpath</span><span class="p">,</span> <span class="n">javaopts</span><span class="p">,</span> <span class="n">die_on_exit</span><span class="p">,</span>
            <span class="n">redirect_stdout</span><span class="o">=</span><span class="n">redirect_stdout</span><span class="p">,</span> <span class="n">redirect_stderr</span><span class="o">=</span><span class="n">redirect_stderr</span><span class="p">,</span>
            <span class="n">daemonize_redirect</span><span class="o">=</span><span class="n">daemonize_redirect</span><span class="p">,</span> <span class="n">java_path</span><span class="o">=</span><span class="n">java_path</span><span class="p">,</span>
            <span class="n">create_new_process_group</span><span class="o">=</span><span class="n">create_new_process_group</span><span class="p">)</span>
        <span class="n">gateway</span> <span class="o">=</span> <span class="n">JavaGateway</span><span class="p">(</span><span class="n">gateway_parameters</span><span class="o">=</span><span class="n">GatewayParameters</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">_port</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">gateway</span>


<span class="c1"># CALLBACK SPECIFIC</span>

<span class="k">class</span> <span class="nc">CallbackServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The CallbackServer is responsible for receiving call back connection</span>
<span class="sd">       requests from the JVM. Usually connections are reused on the Java side,</span>
<span class="sd">       but there is at least one connection per concurrent thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">DEFAULT_PYTHON_PROXY_PORT</span><span class="p">,</span>
            <span class="n">address</span><span class="o">=</span><span class="n">DEFAULT_ADDRESS</span><span class="p">,</span> <span class="n">callback_server_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param pool: the pool responsible of tracking Python objects passed to</span>
<span class="sd">            the Java side.</span>

<span class="sd">        :param gateway_client: the gateway client used to call Java objects.</span>

<span class="sd">        :param callback_server_parameters: An instance of</span>
<span class="sd">            `CallbackServerParameters` used to configure various options of the</span>
<span class="sd">            callback server.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span> <span class="o">=</span> <span class="n">gateway_client</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span> <span class="o">=</span> <span class="n">callback_server_parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callback_server_parameters</span><span class="p">:</span>
            <span class="n">deprecated</span><span class="p">(</span>
                <span class="s2">&quot;CallbackServer.port and address&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;CallbackServerParameters&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span> <span class="o">=</span> <span class="n">CallbackServerParameters</span><span class="p">(</span>
                <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">ssl_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="n">WeakSet</span><span class="p">()</span>
        <span class="c1"># Lock is used to isolate critical region like connection creation.</span>
        <span class="c1"># Some code can produce exceptions when ran in parallel, but</span>
        <span class="c1"># They will be caught and dealt with.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the CallbackServer. This method should be called by the</span>
<span class="sd">        client instead of run().&quot;&quot;&quot;</span>
        <span class="n">af_type</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">af_type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">set_reuse_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="c1"># 4-tuple for ipv6, 2-tuple for ipv4</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listening_address</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listening_port</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;An error occurred while trying to start the callback &quot;</span>\
                  <span class="s2">&quot;server (</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">Py4JNetworkError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># Maybe thread needs to be cleanup up?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>

        <span class="c1"># Default is False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">daemonize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_listening_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the port on which the callback server is listening to.</span>
<span class="sd">        Different than `port` when port is 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listening_port</span>

    <span class="k">def</span> <span class="nf">get_listening_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the address on which the callback server is listening to.</span>
<span class="sd">        May be different than `address` if `address` was an alias (e.g.,</span>
<span class="sd">        localhost).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listening_address</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts listening and accepting connection requests.</span>

<span class="sd">           This method is called when invoking `CallbackServer.start()`. A</span>
<span class="sd">           CallbackServer instance is created and started automatically when</span>
<span class="sd">           a :class:`JavaGateway &lt;py4j.java_gateway.JavaGateway&gt;` instance is</span>
<span class="sd">           created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Callback Server Starting&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Socket listening on </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                <span class="nb">format</span><span class="p">(</span><span class="n">smart_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">())))</span>
            <span class="n">server_started</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

            <span class="n">read_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="p">]</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">:</span>
                <span class="n">readable</span><span class="p">,</span> <span class="n">writable</span><span class="p">,</span> <span class="n">errored</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="n">read_list</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">accept_timeout</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">readable</span><span class="p">:</span>
                    <span class="n">socket_instance</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">read_timeout</span><span class="p">:</span>
                        <span class="n">socket_instance</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">read_timeout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_context</span><span class="p">:</span>
                        <span class="n">socket_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span>
                            <span class="n">socket_instance</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="nb">input</span> <span class="o">=</span> <span class="n">socket_instance</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_connection</span><span class="p">(</span>
                        <span class="n">socket_instance</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                            <span class="n">connection</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                            <span class="n">server_connection_started</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                                <span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">quiet_shutdown</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
                            <span class="n">quiet_close</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error while waiting for a connection.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">server_connection_error</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error while waiting for a connection.&quot;</span><span class="p">)</span>

        <span class="n">server_stopped</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket_instance</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">CallbackConnection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">socket_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">connection</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes all active callback connections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Closing down callback connections from CallbackServer&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">temp_connections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">temp_connections</span><span class="p">:</span>
                <span class="n">quiet_close</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops listening and accepting connection requests. All live</span>
<span class="sd">           connections are closed.</span>

<span class="sd">           This method can safely be called by another thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Callback Server Shutting Down&quot;</span><span class="p">)</span>
        <span class="n">pre_server_shutdown</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span><span class="p">:</span>
                    <span class="c1"># Do not allow calling shutdown while shutdown is</span>
                    <span class="c1"># executing. Alternative would be to not use a</span>
                    <span class="c1"># reentrant lock, but we</span>
                    <span class="c1"># would need to check all the other uses of this lock.</span>
                    <span class="k">return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">quiet_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="p">)</span>
                <span class="n">quiet_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server_socket</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">temp_connections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">temp_connections</span><span class="p">:</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">post_server_shutdown</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CallbackConnection</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `CallbackConnection` receives callbacks and garbage collection</span>
<span class="sd">       requests from the Java side.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">socket_instance</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">,</span>
            <span class="n">callback_server_parameters</span><span class="p">,</span> <span class="n">callback_server</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CallbackConnection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket_instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span> <span class="o">=</span> <span class="n">gateway_client</span>

        <span class="c1"># TODO Remove in 1.0. Take it from the callback_server directly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span> <span class="o">=</span> <span class="n">callback_server_parameters</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">callback_server_parameters</span><span class="p">:</span>
            <span class="c1"># TODO Remove in 1.0. This should never be the case.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span> <span class="o">=</span> <span class="n">CallbackServerParameters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callback_server</span> <span class="o">=</span> <span class="n">callback_server</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_server_parameters</span><span class="o">.</span><span class="n">daemonize_connections</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Callback Connection ready to receive messages&quot;</span><span class="p">)</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">smart_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">readline</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">obj_id</span> <span class="o">=</span> <span class="n">smart_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">readline</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Received command </span><span class="si">{0}</span><span class="s2"> on object id </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                    <span class="nb">format</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">obj_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_id</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">CALL_PROXY_COMMAND_NAME</span><span class="p">:</span>
                    <span class="n">return_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_proxy</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">return_message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="n">proto</span><span class="o">.</span><span class="n">GARBAGE_COLLECT_PROXY_COMMAND_NAME</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">obj_id</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span>
                        <span class="n">proto</span><span class="o">.</span><span class="n">SUCCESS_RETURN_MESSAGE</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown command </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
                    <span class="c1"># We&#39;re sending something to prevent blokincg, but at this</span>
                    <span class="c1"># point, the protocol is broken.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span>
                        <span class="n">proto</span><span class="o">.</span><span class="n">ERROR_RETURN_MESSAGE</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="n">reset</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Timeout while callback connection was waiting for&quot;</span>
                <span class="s2">&quot;a message&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># This is a normal exception...</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Error while callback connection was waiting for&quot;</span>
                <span class="s2">&quot;a message&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">reset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Closing down callback connection&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">set_linger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Send shutdown before closing stream and socket</span>
            <span class="n">quiet_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="n">quiet_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="n">quiet_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="n">already_closed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">already_closed</span><span class="p">:</span>
            <span class="n">server_connection_stopped</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">callback_server</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_call_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">return_message</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">ERROR_RETURN_MESSAGE</span>
        <span class="k">if</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">smart_decode</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">readline</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_params</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">obj_id</span><span class="p">],</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
                <span class="n">return_message</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">RETURN_MESSAGE</span> <span class="o">+</span> <span class="n">proto</span><span class="o">.</span><span class="n">SUCCESS</span> <span class="o">+</span>\
                    <span class="n">get_command_part</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;There was an exception while executing the &quot;</span>
                                 <span class="s2">&quot;Python Proxy on the Python Side.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_message</span>

    <span class="k">def</span> <span class="nf">_get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">smart_decode</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">readline</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">temp</span> <span class="o">!=</span> <span class="n">proto</span><span class="o">.</span><span class="n">END</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span><span class="s2">&quot;y&quot;</span> <span class="o">+</span> <span class="n">temp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">smart_decode</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">readline</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">params</span>


<span class="k">class</span> <span class="nc">PythonProxyPool</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `PythonProxyPool` manages proxies that are passed to the Java side.</span>
<span class="sd">       A proxy is a Python class that implements a Java interface.</span>

<span class="sd">       A proxy has an internal class named `Java` with a member named</span>
<span class="sd">       `implements` which is a list of fully qualified names (string) of the</span>
<span class="sd">       implemented interfaces.</span>

<span class="sd">       The `PythonProxyPool` implements a subset of the dict interface:</span>
<span class="sd">       `pool[id]`, `del(pool[id])`, `pool.put(proxy)`, `pool.clear()`,</span>
<span class="sd">       `id in pool`, `len(pool)`.</span>

<span class="sd">       The `PythonProxyPool` is thread-safe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">force_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a proxy to the pool.</span>

<span class="sd">        :param object: The proxy to add to the pool.</span>
<span class="sd">        :rtype: A unique identifier associated with the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force_id</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">force_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">PYTHON_PROXY_PREFIX</span> <span class="o">+</span> <span class="n">smart_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span>
        <span class="k">return</span> <span class="nb">id</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>

<span class="c1"># Basic registration</span>
<span class="n">register_output_converter</span><span class="p">(</span>
    <span class="n">proto</span><span class="o">.</span><span class="n">REFERENCE_TYPE</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">:</span> <span class="n">JavaObject</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="n">gateway_client</span><span class="p">))</span>

<span class="k">if</span> <span class="n">PY4J_SKIP_COLLECTIONS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">or</span>\
   <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">PY4J_SKIP_COLLECTIONS</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PY4J_TRUE</span><span class="p">:</span>
    <span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;py4j.java_collections&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>